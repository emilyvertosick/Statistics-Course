```{r setup7, include = FALSE, purl = FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Load packages
library(skimr)
library(gtsummary)
library(epiR)
library(broom)
library(pROC)
library(gmodels)
library(survival)
library(survminer)
library(tidyverse)

# Set seed
set.seed(34634986)

# To display histograms from "skim"
Sys.setlocale("LC_CTYPE", "Chinese")

# Load data

# Save out list of all files
all_data <-
  list.files(here::here("Data"), pattern = ".rds", recursive = TRUE) %>%
  map(~ glue::glue("Data/{..1}") %>% as.character())

# Give names to list (will be object names)
all_data_names <-
  map(all_data,
      ~ str_split(..1, "/") %>%
        unlist() %>%
        pluck(3) %>%
        str_replace(".rds", "")
      )
names(all_data) <- all_data_names

# Load all data to environment
list2env(map(all_data, readRDS), envir = .GlobalEnv)

```

# Week 7

## Setting Up

```{r loadpkgs7, echo = TRUE}

# Load packages
library(skimr)
library(gtsummary)
library(epiR)
library(broom)
library(pROC)
library(gmodels)
library(survival)
library(survminer)
library(tidyverse)

# Load data necessary to run Week 7 examples
example7a <- readRDS(here::here("Data", "Week 7", "example7a.rds"))

```

## R Instructions

### Time to event data

You need at least two variables to describe a time to event dataset: how long the patients were followed (the time variable), and whether they had the event (e.g. were alive or dead) at last observation (the failure variable). The failure variable is coded 1 if the patient had the event (e.g. died, had a recurrence) and 0 otherwise. You can have any other variables (patient codes, stage of cancer, treatment, hair color etc) but these are not essential.

You first have to tell R that you are dealing with a survival dataset. The function used is the `Surv` function from the `survival` package. The function is of the form `Surv(t, d)` where "t" is the time variable and "d" is the "failure" variable (e.g. died if 1, alive at last follow-up if 0). You can save out this survival object, but note that if you go and change any data, you have to re-run the `Surv` function so it utilizes the new data.

```{r week7a}

# Create the survival object
# "t" is time in months
# "d" is survival status (0 = alive, 1 = dead)
example7a_surv <- Surv(example7a$t, example7a$d)

```

The `survfit` function (also from the `survival`) package describes the survival data. It is common to report the median survival.

```{r week7b}

# Calculate descriptive statistics on time to event data
# The "~ 1" indicates that we want survival estimates for the entire group
survfit(example7a_surv ~ 1)

```

You often also report the median time of follow-up for survivors, which can easily be calculated manually.

```{r week7c}

# Calculate median followup for survivors only
example7a %>%
  filter(d == 0) %>% # Keep only the surviving patients
  skim(t) # Remember, "p50" indicates the median

```

You can also plot the survival curve by adding the `plot` function around your `survfit` function:

```{r week7d}

# Plot survival curve
plot(survfit(example7a_surv ~ 1))

```

Use "~ covariate" instead of "~ 1" to plot survival curves by group:

```{r week7e}

# Plot survival curve by group (drug vs no drug)
# "~ drug" indicates to plot by "drug", vs "~ 1" which plots for all patients
plot(survfit(example7a_surv ~ drug, data = example7a))

```

Graphs can be saved out by using the "Export" option at the top of the "Plots" tab.

The `survdiff` function compares survival for different groups. For example, the following code compares survival for each value of the variable "drug" (generally 0 and 1).

```{r week7f}

# Compare survival between drug groups
survdiff(example7a_surv ~ drug, data = example7a)

```

The `coxph` function (from `survival`) is for regression analyses. For example, a unvariate regression for the effects of "drug" on survival:

```{r week7g}

# Create Cox regression model
coxph(example7a_surv ~ drug, data = example7a)

# You can use the tbl_regression function with Cox models to see the hazard ratios
example7a_cox <- coxph(example7a_surv ~ drug, data = example7a)
tbl_regression(example7a_cox, exponentiate = TRUE)

```

The following multivariable model also includes some demographic and medical characteristics:

```{r week7h}

# Create multivariable Cox regression model
coxph(example7a_surv ~ drug + age + sex + marker, data = example7a)

```

Using the `summary` function with `survfit` lists all available followup times along with survival probabilities (you get a 95% C.I. as well):

```{r week7i}

# Survival probabilities for the entire cohort
summary(survfit(example7a_surv ~ 1, data = example7a))

# You can also summarize the survival by group:
summary(survfit(example7a_surv ~ drug, data = example7a))

```

The `times` option allows you to get survival probabilities for specific timepoints. For example, at 1 year, 2 years and 5 years:

```{r week7j}

# Get survival probabilities for specific time points in full dataset
# "~ 1" indicates all patients
# "t" variable is in months, so 12, 24 and 60 months used for 1, 2 and 5 years
summary(survfit(example7a_surv ~ 1, data = example7a), times = c(12, 24, 60))

```

So, some typical code to analyze a dataset:

```{r week7k}

# Create your survival object, which indicates this is a time to event outcome
example7a_surv <- Surv(example7a$t, example7a$d)

# Get median survival and number of events for group
survfit(example7a_surv ~ 1)

# Get median followup for survivors
example7a %>%
  filter(d == 0) %>%
  skim(t)

# Show a graph
plot(survfit(example7a_surv ~ 1))

# Look at predictors of survival
coxph(example7a_surv ~ drug + age + sex + marker, data = example7a)

```

## Assignments

```{r assignmentdata, eval = TRUE, purl = TRUE}

# Copy and paste this code to load the data for week 7 assignments
lesson7a <- readRDS(here::here("Data", "Week 7", "lesson7a.rds"))
lesson7b <- readRDS(here::here("Data", "Week 7", "lesson7b.rds"))
lesson7c <- readRDS(here::here("Data", "Week 7", "lesson7c.rds"))
lesson7d <- readRDS(here::here("Data", "Week 7", "lesson7d.rds"))

```

Try to do at least lesson7a and lesson7b.

- lesson7a.rds: This is a large set of data on patients receiving adjuvant therapy after surgery for colon cancer. Describe this dataset and determine which, if any, variables are prognostic in this patient group.

- lesson7b.rds: These are time to recurrence data on forty patients with biliary cancer treated at one of two hospitals, one of which treats a large number of cancer patients and one of which does not. Do patients treated at a “high volume” hospital have a longer time to recurrence?

- lesson7c.rds: These are data from a randomized trial comparing no treatment, levamisole (an immune stimulant) and levamisole combined with 5FU (a chemotherapy agent) and in the adjuvant treatment of colon cancer. Describe the dataset. What conclusions would you draw about the effectiveness of the different treatments?

- lesson7d.rds: More data on time to recurrence by hospital volume. Given this dataset, determine whether patients treated at a “high volume” hospital have a longer time to recurrence.